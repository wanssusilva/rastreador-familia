<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIP Family Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; background: #e0e0e0; }

        /* Estilo das Bolhas de UsuÃ¡rio */
        .marker-container { position: relative; width: 50px; height: 50px; }
        .user-bubble { 
            width: 46px; height: 46px; border-radius: 50%; border: 3px solid #fff;
            box-shadow: 0 0 15px rgba(0,0,0,0.1); display: flex;
            align-items: center; justify-content: center; font-weight: 800;
            color: white; font-size: 16px; transition: transform 0.2s;
        }
        .user-name-tag {
            position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
            background: rgba(44, 62, 80, 0.9); color: white; padding: 3px 10px;
            border-radius: 12px; font-size: 10px; font-weight: 600; white-space: nowrap;
        }

        /* Tela de Entrada (Apenas 1Âª vez) */
        #login-overlay { 
            position: fixed; inset: 0; background: #fff; z-index: 9999; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
        }
        .login-box { width: 85%; max-width: 350px; text-align: center; }
        input { width: 100%; padding: 15px; margin: 20px 0; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; outline: none; box-sizing: border-box; }
        button.entry-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; background: #2c3e50; color: white; font-weight: 700; cursor: pointer; }

        /* Controles Flutuantes */
        .map-ui { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .ui-btn { width: 50px; height: 50px; border-radius: 15px; border: none; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="letter-spacing:-1px">FamÃ­lia Tracker</h2>
            <p style="color:#7f8c8d; font-size:14px">Digite seu nome para comeÃ§ar</p>
            <input type="text" id="inputName" placeholder="Seu nome">
            <button class="entry-btn" onclick="startApp()">ENTRAR AGORA</button>
        </div>
    </div>

    <div class="map-ui">
        <button class="ui-btn" onclick="focusAll()">ðŸ‘¥</button>
        <button class="ui-btn" onclick="location.reload()">ðŸ”„</button>
    </div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPwwAWS2aiEqeFJX1ARgRmHzFEj5RCpiw",
            databaseURL: "https://rastreador-familia-6fe52-default-rtdb.firebaseio.com/",
            projectId: "rastreador-familia-6fe52",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let map, myName, markers = {}, activeTrail = null;
        const palette = ['#3498db', '#e74c3c', '#2ecc71', '#9b59b6', '#f1c40f'];

        window.onload = () => {
            myName = localStorage.getItem('user_tracker_name');
            if (myName) initMap();
            else document.getElementById('login-overlay').style.display = 'flex';
        };

        function startApp() {
            const n = document.getElementById('inputName').value.trim();
            if (n) { localStorage.setItem('user_tracker_name', n); location.reload(); }
        }

        function initMap() {
            // MAPA VOYAGER: Limpo, agradÃ¡vel e sem detalhes poluÃ­dos
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0,0], 15);
            
            const tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                timeout: 5000 // Tenta carregar por 5 segundos antes de erro
            }).addTo(map);

            // AUTO-RECARREGAMENTO: Se o mapa falhar ao carregar, ele tenta de novo sozinho
            tiles.on('tileerror', () => {
                console.log("Erro ao carregar mapa, tentando novamente...");
                setTimeout(() => tiles.redraw(), 3000);
            });

            syncFamily();
            trackMe();
            cleanOld(48);
        }

        function syncFamily() {
            db.ref('familia').on('value', snap => {
                const data = snap.val();
                for (let id in data) {
                    const u = data[id];
                    const color = palette[Math.abs(id.length) % palette.length];

                    if (markers[id]) {
                        markers[id].setLatLng([u.lat, u.lng]);
                    } else {
                        markers[id] = L.marker([u.lat, u.lng], {
                            icon: L.divIcon({
                                className: 'custom-div-icon',
                                html: `<div class="marker-container">
                                        <div class="user-bubble" style="background:${color}">${id.substring(0,2).toUpperCase()}</div>
                                        <div class="user-name-tag">${id}</div>
                                       </div>`,
                                iconSize: [50, 50], iconAnchor: [25, 50]
                            })
                        }).addTo(map).on('click', () => showHistory(id, u.trajetos, color));
                    }
                }
            });
        }

        function showHistory(id, pts, color) {
            if (activeTrail) map.removeLayer(activeTrail);
            if (!pts) return;
            const path = Object.values(pts).map(p => [p.lat, p.lng]);
            activeTrail = L.polyline(path, {color: color, weight: 4, opacity: 0.6, dashArray: '5, 10'}).addTo(map);
        }

        function trackMe() {
            navigator.geolocation.watchPosition(p => {
                const { latitude, longitude } = p.coords;
                const r = db.ref('familia/' + myName);
                r.update({ lat: latitude, lng: longitude });
                r.child('trajetos').push({ lat: latitude, lng: longitude, t: Date.now() });
                if(Object.keys(markers).length <= 1) map.panTo([latitude, longitude]);
            }, null, { enableHighAccuracy: true });
        }

        function cleanOld(hrs) {
            const limit = Date.now() - (hrs * 60 * 60 * 1000);
            db.ref('familia').once('value', s => {
                s.forEach(u => u.child('trajetos').forEach(p => { if(p.val().t < limit) p.ref.remove(); }));
            });
        }

        function focusAll() {
            const m = Object.values(markers);
            if (m.length > 0) map.fitBounds(new L.featureGroup(m).getBounds().pad(0.3));
        }
    </script>
</body>
</html>
